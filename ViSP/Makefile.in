SHELL=/bin/sh

@build_mk@

.DELETE_ON_ERROR:

.DEFAULT: all
all: bin

bin: lib FORCE
	cd test; $(MAKE)
	cd example; $(MAKE)

lib: directory FORCE
	cd include; $(MAKE)
	cd src; $(MAKE)
	$(MAKE) shared-lib
	$(MAKE) lib-link

test: lib FORCE
	cd test; $(MAKE)

example: lib FORCE
	cd example; $(MAKE)

@directory_mk@

@sharedlib_mk@

clean:
	cd include; $(MAKE) $@
	cd src; $(MAKE) $@
	cd test; $(MAKE) $@
	cd example; $(MAKE) $@
	rm -f $(VISP_DEP_PATH)/*.P
	rm -f $(VISP_OBJ_PATH)/*.o
	rm -f $(VISP_LIB_PATH)/libvisp-2$(SUFFIX).a
	rm -f $(VISP_LIB_PATH)/libvisp-2$(SUFFIX).so
	rm -f $(STATIC_LIB_PATH)
	rm -f $(SHARED_LIB_PATH)
	@for i in `find -type f -name "*~" -print | sort` ; do\
		rm -f $$i;\
		echo "rm -f " $$i;\
	done
	@for i in `find -type f -name "tca.*" -print | sort` ; do\
		rm -f $$i;\
		echo "rm -f " $$i;\
	done
	@for i in `find -type d -name pchdir -print | sort` ; do\
		rm -fr $$i;\
		echo "rm -fr " $$i;\
	done
	@for i in `find -type f -name "*.d" -print | sort` ; do\
		rm -f $$i;\
		echo "rm -f " $$i;\
	done
	@for i in `find -type f -name .inslog2 -print | sort` ; do\
		rm -f $$i;\
		echo "rm -f " $$i;\
	done
	@for i in `find -type f -name "tca.*" -print | sort` ; do\
		rm -f $$i;\
		echo "rm -f " $$i;\
	done
	@for i in `find -type d -name pchdir -print | sort` ; do\
		rm -fr $$i;\
		echo "rm -fr " $$i;\
	done


distclean:
	$(MAKE) clean;
	rm -f config.log config.status
	rm -rf $(VISP_DIR_DEP)
	rm -rf $(VISP_DIR_OBJ)
	rm -rf lib/*
	rm -rf doc/html
	rm -f  doc/warning.log
	@for i in `find -type f -name .depend -print | sort` ; do\
		rm -f $$i;\
		echo "rm -f " $$i;\
	done
	@for i in `find -type f -name "*.exe" -print | sort` ; do\
		rm -f $$i;\
		echo "rm -f " $$i;\
	done
	@for i in `find -type f -name Makefile.in -print | sort` ; do\
		filetoremove=`echo "$$i" | sed -e "s;Makefile.in;Makefile;g"`;\
		rm -f $${filetoremove};\
		echo "rm -f " $${filetoremove};\
	done
	@for i in `find -type f -name build.mk.in -print | sort` ; do\
		filetoremove=`echo "$$i" | sed -e "s;build.mk.in;build.mk;g"`;\
		rm -f $${filetoremove};\
		echo "rm -f " $${filetoremove};\
	done
	@for i in `find -type f -name vpConfig.h.in -print | sort` ; do\
		filetoremove=`echo "$$i" | sed -e "s;vpConfig.h.in;vpConfig.h;g"`;\
		rm -f $${filetoremove};\
		echo "rm -f " $${filetoremove};\
	done
	@for i in `find -type f -name config-doxygen.in -print | sort` ; do\
		filetoremove=`echo "$$i" | sed -e "s;config-doxygen.in;config-doxygen;g"`;\
		rm -f $${filetoremove};\
		echo "rm -f " $${filetoremove};\
	done

html-doc:
	@echo "html documentation creation..."
	cd doc; doxygen config-doxygen

group-access:
	@echo "Changing group access in process..."
	chmod -R g+rw .
	find . -type d -exec chmod g+rwx {} \;
	@for i in `find -type f -name "*.exe" -print | sort` ; do\
		chmod g+rwx $$i;\
		echo "chmod g+rwx" $$i;\
	done
	@echo "done."

install: bin
	test -z "$(INSTALL_LIBDIR)" || $(mkdir_p) "$(INSTALL_LIBDIR)"
	$(INSTALL_DATA) $(STATIC_LIB_PATH) $(INSTALL_LIBDIR)
	$(INSTALL_DATA) $(SHARED_LIB_PATH) $(INSTALL_LIBDIR)
	rm -f $(INSTALL_LIBDIR)/libvisp-2$(SUFFIX).a
	ln -s $(INSTALL_LIBDIR)/$(STATIC_LIB_NAME) $(INSTALL_LIBDIR)/libvisp-2$(SUFFIX).a
	rm -f $(INSTALL_LIBDIR)/libvisp-2$(SUFFIX).so
	ln -s $(INSTALL_LIBDIR)/$(SHARED_LIB_NAME) $(INSTALL_LIBDIR)/libvisp-2$(SUFFIX).so
	test -z "$(INSTALL_INCDIR)" || $(mkdir_p) "$(INSTALL_INCDIR)"
	$(INSTALL_DATA) $(VISP_DIR_INCLUDE)/visp/*.h $(INSTALL_INCDIR)
	$(INSTALL_DATA) $(VISP_DIR_INCLUDE)/visp/*.t.cpp $(INSTALL_INCDIR)

uninstall:
	rm -f $(INSTALL_LIBDIR)/libvisp-2$(SUFFIX).a
	rm -f $(INSTALL_LIBDIR)/$(STATIC_LIB_NAME)
	rm -f $(INSTALL_LIBDIR)/libvisp-2$(SUFFIX).so
	rm -f $(INSTALL_LIBDIR)/$(SHARED_LIB_NAME)
	rm -fr $(INSTALL_INCDIR)


FORCE:
